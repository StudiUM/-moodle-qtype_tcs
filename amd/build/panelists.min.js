/**
 * Send emails for panelist page.
 *
 * @module     mod_concordance/panelists
 * @copyright  2020 Université de Montréal
 * @author     Issam Taboubi <issam.taboubi@umontreal.ca>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_concordance/panelists",["jquery","core/str","core/modal_factory","core/modal_events","core/templates","core/notification","core/ajax"],(function($,Str,ModalFactory,ModalEvents,Templates,Notification,Ajax){var SELECTORS_SENDACTIONBUTTON="#showpanelistemailpopup",SELECTORS_PANELISTSSELECTEDCHECKBOXES="input[name='panelists']:checked",SELECTORS_PANELISTSCHECKBOXES="input[name='panelists']",SELECTORS_CHECKALLLINK="#checkall",SELECTORS_CHECKNONELINK="#checknone",Panelists=function(options){this.cmid=options.cmid,this.attachEventListeners()};return Panelists.prototype.modal=null,Panelists.prototype.cmid=-1,Panelists.prototype.attachEventListeners=function(){$(SELECTORS_SENDACTIONBUTTON).on("click",function(e){e.preventDefault();var ids=[];$(SELECTORS_PANELISTSSELECTEDCHECKBOXES).each((function(index,ele){var id=$(ele).val();ids.push(id)})),this.showSendEmail(ids).fail(Notification.exception)}.bind(this)),$(SELECTORS_CHECKALLLINK).on("click",(function(e){e.preventDefault(),$(SELECTORS_PANELISTSCHECKBOXES).prop("checked",!0),$(SELECTORS_SENDACTIONBUTTON).prop("disabled",!1)})),$(SELECTORS_CHECKNONELINK).on("click",(function(e){e.preventDefault(),$(SELECTORS_PANELISTSCHECKBOXES).prop("checked",!1),$(SELECTORS_SENDACTIONBUTTON).prop("disabled",!0)})),$(SELECTORS_PANELISTSCHECKBOXES).on("change",(function(){$(SELECTORS_PANELISTSSELECTEDCHECKBOXES).length>0?$(SELECTORS_SENDACTIONBUTTON).prop("disabled",!1):$(SELECTORS_SENDACTIONBUTTON).prop("disabled",!0)}))},Panelists.prototype.showSendEmail=function(users){if(0==users.length)return $.Deferred().resolve().promise();var titlePromise=null;titlePromise=1==users.length?Str.get_string("sendbulkmessagesingle","core_message"):Str.get_string("sendbulkmessage","core_message",users.length);var loadingtxtPromise=Str.get_string("loading");return $.when(ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,body:Templates.render("mod_concordance/send_bulk_email",{})}),titlePromise,loadingtxtPromise).then(function(modal,title,loadingtxt){this.modal=modal,this.modal.setTitle(title),this.modal.setSaveButtonText(title),this.modal.getRoot().on(ModalEvents.hidden,function(){$(SELECTORS_SENDACTIONBUTTON).focus(),this.modal.getRoot().remove()}.bind(this)),this.modal.getRoot().on(ModalEvents.save,this.submitSendEmail.bind(this,users,loadingtxt));var self=this;return this.modal.getRoot().on("change keyup","#subject-bulk-email, #body-bulk-email",(function(){var messageText=self.modal.getRoot().find("form textarea").val(),subject=self.modal.getRoot().find("form input").val();messageText=messageText.trim(),subject=subject.trim(subject),0===messageText.length||0===subject.length?self.modal.getRoot().find('button[data-action="save"]').prop("disabled",!0):self.modal.getRoot().find('button[data-action="save"]').prop("disabled",!1)})),this.modal.show(),this.modal}.bind(this))},Panelists.prototype.submitSendEmail=function(users,loadingtxt,e){e.preventDefault();var messageText=this.modal.getRoot().find("form textarea").val(),subject=this.modal.getRoot().find("form input").val(),loading='<i class="fa fa-spinner fa-pulse m-l-1"></i><span class="sr-only">'+loadingtxt+"</span>";return this.modal.getRoot().find('button[data-action="save"]').append(loading),this.modal.getRoot().find(".modal-content").css("pointer-events","none"),Ajax.call([{methodname:"mod_concordance_send_message",args:{users:users,message:messageText,subject:subject,cmid:this.cmid,displaynotification:!0}}])[0].then((function(result){return result&&window.location.reload(!0),!0})).catch(Notification.exception)},{init:function(options){return new Panelists(options)}}}));

//# sourceMappingURL=panelists.min.js.map